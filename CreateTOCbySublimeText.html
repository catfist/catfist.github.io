<!DOCTYPE html><html><head><meta charset="utf-8"><link href='https://dl.dropboxusercontent.com/u/6033699/st_markdown.css' rel='stylesheet' type='text/css'><title>Sublime TextによるTOC生成</title></head><body><h1>Sublime TextによるTOC生成</h1>

<div class="toc">
<ul>
<li><a href="#参考">参考</a></li>
<li><a href="#目次付きのHTML生成">目次付きのHTML生成</a></li>
<li><a href="#手順">手順</a><ul>
<li><a href="#注意点">注意点</a></li>
</ul>
</li>
<li><a href="#さらに任意のヘッダIDを与える">さらに任意のヘッダIDを与える</a><ul>
<li><a href="#正規表現置換によりヘッダIDフォーマットを生成">正規表現置換によりヘッダIDフォーマットを生成</a></li>
</ul>
</li>
<li><a href="#CSSの変更">CSSの変更</a><ul>
<li><a href="#変更方法">変更方法</a></li>
<li><a href="#markdown.cssの変更内容">markdown.cssの変更内容</a></li>
</ul>
</li>
<li><a href="#残る課題">残る課題</a></li>
<li><a href="#Writer">Writer</a></li>
</ul>
</div>
<h2 id="参考"><a name="user-content-参考" href="#参考" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>参考</h2>
<ul>
<li><a href="http://qiita.com/naokazu_terada/items/daa34bf80fa683d80b6d">SublimeText2 - Markdownの目次自動作成（ST2 PlugIn） - Qiita</a></li>
<li><a href="http://codedehitokoto.blogspot.jp/2012/04/sublimetext2markdown.html">コードで一言: SublimeText2でMarkdownをプレビューするプラグイン</a></li>
<li><a href="http://bellonieta.net/2013/05/sublimetext2%E3%81%A7markdown%E3%81%ABtoc%E3%82%92%E6%8C%BF%E5%85%A5%E3%81%99%E3%82%8B/">SublimeText2でMarkdownにTOCを挿入する</a></li>
</ul>
<h2 id="目次付きのHTML生成"><a name="user-content-目次付きのHTML生成" href="#目次付きのHTML生成" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>目次付きのHTML生成</h2>
<p>長文のテキストを公開するに当たっては、目次（Table of Contents）が欲しいものです。どうにか簡単にTOCを生成できないかと考え、一度はStackEdit+WordPressに落ち着きました。</p>
<p>ただし、StackEditが生成するTOCは、<code>h1</code>タグに相当する<code>#</code>の見出しがないと、<strong>空のリストアイテムを生成する</strong>という欠点があります。</p>
<p>StackEditの動作がかなり重いということもあり、他のソリューションを検討することにしました。</p>
<ul>
<li>Pandoc / Sphinx<ul>
<li>オプションでTOC付けられるらしい</li>
<li>コマンドラインツールとか無理</li>
</ul>
</li>
<li>Notebooks for Mac<ul>
<li>TOC挿入してHTMLに変換できる</li>
<li>不具合いろいろ<ul>
<li>自動生成されるアンカーにおいて、日本語文字が一律に<code>.</code>に変換される<ul>
<li>文字数が同じだと同名のアンカーになるため、正常にジャンプできない</li>
</ul>
</li>
<li>そもそもフォーマット変換の挙動が全体的に怪しい</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>次に検討したのがSublime Textで、これはうまくいったので手順をまとめます。なお、このドキュメント自体が、記述した方法で生成されています。</p>
<h2 id="手順"><a name="user-content-手順" href="#手順" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>手順</h2>
<p>以下は、Sublime Text 3前提です。</p>
<ul>
<li><a href="https://github.com/revolunet/sublimetext-markdown-preview">Markdown Preview</a>パッケージを導入</li>
<li>Markdownドキュメントを書く</li>
<li>任意の位置に<code>[TOC]</code>を挿入</li>
<li>HTML変換時、<code>[TOC]</code>位置にアンカー付きの目次が生成される<ul>
<li>HTML変換系のコマンドは、ブラウザプレビュー、HTMLエクスポートまたはビルド（⌘B）</li>
</ul>
</li>
</ul>
<p>この方式の利点は、少ない手数で、ローカルに完全なHTMLファイルが残る点です。そのため、Sublime Textの各種パッケージを利用して、FTPアップロードなどが簡単にできます。</p>
<h3 id="注意点"><a name="user-content-注意点" href="#注意点" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>注意点</h3>
<ul>
<li>TOCからリンクされるヘッダIDにおいて、日本語文字は無視される（削除される）<ul>
<li>ただし、ヘッダIDが重複した場合、自動的に連番が振られ重複が解消される</li>
</ul>
</li>
<li>所定のCSSでは中国語フォントが指定されている</li>
</ul>
<h2 id="さらに任意のヘッダIDを与える"><a name="user-content-さらに任意のヘッダIDを与える" href="#さらに任意のヘッダIDを与える" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>さらに任意のヘッダIDを与える</h2>
<p>上記の通り、日本語の見出しでヘッダIDを自動生成すると、連番のみのヘッダIDが頻出します。TOCからのリンクだけを考えるなら特に問題はありませんが、手動で文中リンクを張る場合、文書構造を変更するとヘッダIDが変更され、リンクが無効化されることになります。</p>
<p>ここで、Markdown PreviewパッケージによるTOCの生成が、どのようなシステムで行われているのか考えてみます。</p>
<ul>
<li>TOCの生成においては、Markdown Previewパッケージに組み込まれた<a href="https://pythonhosted.org/Markdown/">Python Markdown</a>パーサー ライブラリが利用されている</li>
<li>このパーサーには<a href="https://pythonhosted.org/Markdown/extensions/toc.html">Table of Contents拡張</a>が存在し、これがMarkdown Previewパッケージから利用されている</li>
<li>同様の拡張である<a href="https://pythonhosted.org/Markdown/extensions/header_id.html">HeaderId</a>を利用することで、任意のヘッダIDを生成することができる。</li>
</ul>
<p>そこで、HeaderID拡張の仕様に従い、以下のように記述します。</p>
<pre><code>### さらに任意のヘッダIDを与える { #さらに任意のヘッダIDを与える }
</code></pre>
<p>これが、以下のようなHTMLに変換されます。</p>
<pre><code>&lt;h3 id=&rdquo;さらに任意のヘッダIDを与える&rdquo;&gt;&lt;a name=&rdquo;user-content-さらに任意のヘッダIDを与える&rdquo; href=&rdquo;#さらに任意のヘッダIDを与える&rdquo; class=&rdquo;headeranchor-link&rdquo; aria-hidden=&rdquo;true&rdquo;&gt;&lt;span class=&rdquo;headeranchor&rdquo;&gt;&lt;/span&gt;&lt;/a&gt;さらに任意のヘッダIDを与える&lt;/h3&gt;</code></pre>
<h3 id="正規表現置換によりヘッダIDフォーマットを生成"><a name="user-content-正規表現置換によりヘッダIDフォーマットを生成" href="#正規表現置換によりヘッダIDフォーマットを生成" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>正規表現置換によりヘッダIDフォーマットを生成</h3>
<p>ヘッダIDを付けていなかったので、以下のように置換しました。</p>
<dl>
<dt>検索</dt>
<dd><code>^(#+ )(.*)$</code></dd>
<dt>置換</dt>
<dd><code>$1$2 { #$2 }</code></dd>
</dl>
<p>ただし、これだとヘッダIDにスペースが残ってしまい、正常にリンクされません。そのため、以下の置換を数回実行して削除しました。もう少しうまいやりかたもありそうですが…</p>
<dl>
<dt>検索</dt>
<dd><code>^(\#+.*) \{ \#(.*) (.* \})</code></dd>
<dt>置換</dt>
<dd><code>$1 { #$2$3</code></dd>
</dl>
<p>ただ、たまたま試したドキュメントにFenced Codeblock内のMarkdownヘッダが含まれていたため、まとめて置換されてしまい、面倒な思いをしました。</p>
<h2 id="CSSの変更"><a name="user-content-CSSの変更" href="#CSSの変更" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>CSSの変更</h2>
<p>先述の通り、初期状態のMarkdown PreviewによるCSSには、フォント指定の問題があります。</p>
<p>また、目次部分にCSSで自動的に連番を振りたかったため、CSSを変更することにしました。</p>
<h3 id="変更方法"><a name="user-content-変更方法" href="#変更方法" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>変更方法</h3>
<p>Sublime Text 3のPackage Controlでインストールされるパッケージはアーカイブ化されており、そのままでは内部のファイルを編集することができません。ビルトインされたCSSファイル自体を編集するには、以下の方法でパッケージファイルを解凍する必要があります。</p>
<ul>
<li><a href="http://sonoshou.hatenablog.jp/entry/2013/12/20/Sublime_Text_%E3%81%A7_Markdown%EF%BC%8E">Sublime Text で Markdown． - sonoshouのまじめなブログ</a></li>
</ul>
<p>ただし、そこまでしなくとも、Markdown Previewパッケージの設定ファイルに外部CSSを記述することができるため、<a href="https://github.com/revolunet/sublimetext-markdown-preview">Github</a>からmarkdown.cssを取ってきて、編集した上でDropboxに置き、公開リンクを発行することにしました。</p>
<p>Markdown Previewユーザー設定ファイルに、以下のような記述を追加します。</p>
<pre><code>&ldquo;css&rdquo;: &ldquo;https://dl.dropboxusercontent.com/u/6033699/st_markdown.css&rdquo;,</code></pre>
<h3 id="markdown.cssの変更内容"><a name="user-content-markdown.cssの変更内容" href="#markdown.cssの変更内容" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>markdown.cssの変更内容</h3>
<p>12行目を以下に変更（参考：：<a href="http://www.dtp-transit.jp/misc/web/post_1881.html">CSSでのフォント指定について考える（2014年） - DTP Transit（Mac OS X, OS X Mavericks, Web Fonts, Web制作, iPhone, フォント）</a>）</p>
<pre><code>font-family:Verdana, &ldquo;游ゴシック&rdquo;, YuGothic, &ldquo;Hiragino Kaku Gothic ProN&rdquo;, Meiryo, sans-serif;</code></pre>
<p>TOC自動連番化のため、以下を追加</p>
<pre><code>/* TOCに自動連番 */
div.toc ol,ul{
  counter-reset: item
}
div.toc li { display: block }
div.toc li a { margin-left: 0.5em;  }
div.toc li:before { content: counters(item, &ldquo;.&rdquo;); counter-increment: item }</code></pre>
<p>この際、<code>H1</code>をMarkdownで書くとそれ込みで連番化されるので、ここだけHTMLで書いたほうがよりよいでしょう。目次化する見出しレベルを指定する方法は見つかりませんでした。</p>
<h2 id="残る課題"><a name="user-content-残る課題" href="#残る課題" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>残る課題</h2>
<p>この方法で生成したHTMLの<code>title</code>要素は、ファイル名が割り当てられます。ファイル名を日本語にすることは好ましくないため、タイトルが英語になってしまうことになります。</p>
<p>Markdown Previewには、<code>title</code>要素を指定するために、Python Markdownのmeta拡張およびYAML Front Matterが用意されています。しかし、どちらも正常に展開することができませんでした。これは課題として持ち越し、生成されたHTMLファイルの<code>title</code>要素を手動で書き換えています。</p>
<h2 id="Writer"><a name="user-content-Writer" href="#Writer" class="headeranchor-link"  aria-hidden="true"><span class="headeranchor"></span></a>Writer</h2>
<p>catfist (@<a href="https://twitter.com/catfist">Twitter</a>)</p></body></html>